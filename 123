#!/bin/bash

set -euo pipefail
LOGFILE="/root/mythic_install_log.txt"
exec > >(tee -a "$LOGFILE") 2>&1

echo "[+] Starting full Mythic C2 setup on Ubuntu 22.04..."

function check_success {
    if [ $? -ne 0 ]; then
        echo "[!] ERROR at step: $1. Check the logs at $LOGFILE"
        exit 1
    fi
}

echo "[+] Updating system..."
apt-get update && apt-get upgrade -y
check_success "System Update"

echo "[+] Installing dependencies..."
apt-get install -y git curl wget unzip apt-transport-https ca-certificates gnupg lsb-release gnupg2 software-properties-common python3 python3-pip make jq lynx w3m
check_success "Dependency Install"

echo "[+] Installing Docker (20.10.24)..."
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable"
apt-get update
apt-get install -y docker-ce=5:20.10.24~3-0~ubuntu-jammy docker-ce-cli=5:20.10.24~3-0~ubuntu-jammy containerd.io docker-buildx-plugin docker-compose-plugin
check_success "Docker Install"

echo "[+] Enabling Docker..."
systemctl enable docker
systemctl start docker

echo "[+] Installing Docker Compose v2..."
ln -s /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
docker-compose version
check_success "Docker Compose Install"

echo "[+] Cloning Mythic C2 framework..."
cd /opt
git clone https://github.com/its-a-feature/Mythic.git
check_success "Clone Mythic"

cd Mythic
./install_docker_and_dependencies.sh
check_success "Mythic Dependencies"

echo "[+] Installing Mythic CLI..."
pip3 install mythic-cli
check_success "Mythic CLI Install"

echo "[+] Installing all C2 Profiles..."
C2_PROFILES=(
    "http"
    "httpx"
    "websocket"
    "dns"
    "dynamichttp"
    "smb"
    "tcp"
    "discord"
    "github"
    "slack"
    "dropbox"
    "twitter"
)

for profile in "${C2_PROFILES[@]}"; do
    mythic-cli install github https://github.com/MythicC2Profiles/$profile || echo "[!] Failed to install profile $profile"
done

echo "[+] Installing all Agents..."
AGENTS=(
    "poseidon"
    "apollo"
    "athena"
    "xenon"
    "apfell"
    "leviathan"
    "medusa"
    "thanatos"
    "hannibal"
    "venus"
    "ghostwriter"
    "nemesis"
    "bloodhound"
    "sliver"
)

for agent in "${AGENTS[@]}"; do
    mythic-cli install github https://github.com/MythicAgents/$agent || echo "[!] Failed to install agent $agent"
done

echo "[+] Generating self-signed certificate for HTTPS..."
mkdir -p /opt/Mythic/ssl
openssl req -newkey rsa:4096 -nodes -keyout /opt/Mythic/ssl/mythic.key -x509 -days 365 -out /opt/Mythic/ssl/mythic.crt -subj "/C=US/ST=None/L=None/O=MythicRedTeam/CN=localhost"
check_success "Self-Signed Cert"

echo "[+] Editing Mythic environment for HTTPS..."
sed -i '/MYTHIC_SERVER_PORT/d' .env
echo "MYTHIC_SERVER_PORT=7443" >> .env
sed -i '/MYTHIC_HTTPS/d' .env
echo "MYTHIC_HTTPS=True" >> .env
echo "MYTHIC_HTTPS_CERT=/ssl/mythic.crt" >> .env
echo "MYTHIC_HTTPS_KEY=/ssl/mythic.key" >> .env

echo "[+] Starting Mythic..."
./mythic-cli start
check_success "Mythic Start"

echo "[+] Downloading offensive tools..."
mkdir -p /opt/tools && cd /opt/tools

git clone https://github.com/gentilkiwi/mimikatz.git || echo "[!] Failed to clone Mimikatz"
git clone https://github.com/BloodHoundAD/SharpHound.git || echo "[!] Failed to clone SharpHound"
git clone https://github.com/r3motecontrol/Ghostpack-CompiledBinaries.git || echo "[!] Failed to clone Ghostpack (Rubeus, Seatbelt, etc.)"

echo "[+] Setup complete."
echo "============================================"
echo "Access Mythic C2 via lynx or w3m: https://localhost:7443"
echo "Run Mythic CLI: cd /opt/Mythic && ./mythic-cli"
echo "Log file saved to: $LOGFILE"
echo "============================================"
